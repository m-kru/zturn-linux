hbs::SetBuildDir "build/gw"
hbs::AddFileIgnoreRegex "buildroot"

namespace eval zturn {
  proc top {} {
    hbs::SetTool "vivado-prj"
    hbs::SetDevice "xc7z020clg400-1"
    hbs::Eval {set_property target_language VHDL [current_project]}

    hbs::AddFile gw/ps/processing_system.bd
    hbs::Eval {make_wrapper -files [get_files processing_system.bd] -top}
    hbs::AddFile gw/ps/hdl/processing_system_wrapper.vhd

    hbs::AddFile gw/axi/m-gp0-axilite-apb3-bridge/m_gp0_axilite_apb3_bridge.xci
    hbs::AddFile gw/axi/m-gp0-axi-axilite-bridge/m_gp0_axi_axilite_bridge.xci

    hbs::AddFile gw/top.vhd
    hbs::AddFile gw/constr/top.xdc

    hbs::AddFile gw/constr/target.xdc
    hbs::Eval {set_property target_constrs_file [get_files target.xdc] [current_fileset -constrset]}

    hbs::AddDep vhdl::amba5::apb::pkg::src
    hbs::AddDep vhdl::amba5::apb::serial-bridge::src
    hbs::AddDep vhdl::amba5::apb::cdc-bridge::src

    hbs::AddDep vhdl::tinyuart::src

    hbs::AddDep afbd::gen vhdl-apb -path build/afbd \
      c-sync -linux-mmap-iface -offset-addr -path fw/examples/autogen/afbd \
      json -path build/afbd \
      fbd/main.fbd

    hbs::SetTop "Top"
    hbs::Run

    hbs::Eval "write_hw_platform -fixed -include_bit -force -file $hbs::RunTargetBuildDir/$hbs::Top.xsa"
  }

  hbs::Register
}
